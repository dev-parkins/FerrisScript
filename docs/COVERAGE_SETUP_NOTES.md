# Test Coverage Setup Notes

## Executive Summary

FerrisScript uses a **dual-tool coverage approach**:

- **cargo-llvm-cov**: For local development (Windows, macOS, Linux)
- **cargo-tarpaulin**: For CI/CD (Linux runners in GitHub Actions)

This document provides technical background on why we use two tools and how they're configured.

---

## Windows File Locking Issues with Tarpaulin

**Date**: October 2, 2025  
**Issue**: `cargo-tarpaulin` experiences file locking issues on Windows (OS error 32)  
**Status**: ✅ Resolved by using llvm-cov for local development

### Problem Description

When running `cargo tarpaulin` on Windows, the tool encounters file locking errors:

```
Error: "Access is denied. (os error 5)" or "The process cannot access the file because it is being used by another process. (os error 32)"
```

**Root Cause**:

Tarpaulin attempts to clean the build directory but encounters locked files held by:

- **rust-analyzer** (VS Code extension) - actively indexing and checking code
- **IDE processes** - file watchers, language servers
- **Windows file system** - more aggressive file locking than Linux
- **Background compilation** - parallel cargo processes

### Investigation and Attempted Solutions

| Approach | Command | Result | Notes |
|----------|---------|--------|-------|
| Default execution | `cargo tarpaulin --workspace` | ❌ Failed | Failed at cargo clean step |
| Skip clean flag | `cargo tarpaulin --workspace --skip-clean` | ❌ Failed | Still hit file locks during test execution |
| Close IDE | Close VS Code + `cargo tarpaulin` | ✅ Works | Too disruptive for workflow |
| Kill processes | `Stop-Process rust-analyzer` + tarpaulin | ✅ Works | Inconvenient, IDE restart needed |
| Use CI only | CI on Linux | ✅ Works | No local coverage feedback |
| Switch to llvm-cov | `cargo llvm-cov` | ✅ Works | Best solution, no file locking issues |

---

## Selected Solution: Dual-Tool Approach

### Local Development: cargo-llvm-cov

**Installation**:

```powershell
# Install LLVM tools component
rustup component add llvm-tools-preview

# Install cargo-llvm-cov
cargo install cargo-llvm-cov

# Verify installation
cargo llvm-cov --version
```

**Usage**:

```bash
# HTML report (human-readable)
cargo llvm-cov --workspace --html --output-dir target/coverage

# LCOV report (tool integration)
cargo llvm-cov --workspace --lcov --output-path target/coverage/lcov.info
```

**Advantages**:

- ✅ **No file locking issues** on Windows
- ✅ **Native Rust tooling** (uses LLVM built into rustc)
- ✅ **Cross-platform** (Windows, macOS, Linux)
- ✅ **Faster execution** (no need to rebuild with instrumentation)
- ✅ **LCOV output** compatible with standard tools
- ✅ **Active maintenance** by Rust project members

**Disadvantages**:

- ⚠️ Slightly different coverage algorithm than tarpaulin
- ⚠️ May report different percentages (usually within 1-3%)

### CI/CD: cargo-tarpaulin

**GitHub Actions Configuration**:

```yaml
# .github/workflows/ci.yml
coverage:
  name: Code Coverage
  runs-on: ubuntu-latest  # Linux - no file locking issues
  steps:
    - name: Install tarpaulin
      run: cargo install cargo-tarpaulin
    
    - name: Generate coverage
      run: cargo tarpaulin --workspace --out Xml --output-dir coverage
    
    - name: Upload to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/cobertura.xml
```

**Advantages**:

- ✅ **Mature CI integration** with Codecov, Coveralls
- ✅ **No Windows file locking** (runs on Linux)
- ✅ **Cobertura XML output** for CI tools
- ✅ **Well-established** in Rust ecosystem
- ✅ **Consistent with tarpaulin.toml** configuration

**Disadvantages**:

- ❌ **Windows incompatible** (file locking issues)
- ⚠️ Requires Linux environment
- ⚠️ Slower execution (requires instrumentation rebuild)

---

## Configuration Files

### tarpaulin.toml

Used by CI (tarpaulin on Linux):

```toml
[tool]
out = ["Html", "Lcov", "Stdout"]
output-dir = "target/coverage"
workspace = true
timeout = "5m"
follow-exec = true
count = true
fail-under = 0  # Currently no enforcement

[report]
branches = true
lines = true
```

**Purpose**: Configure tarpaulin behavior in CI for consistent coverage reports.

**Note**: This file is **not used by llvm-cov**. Local coverage uses llvm-cov command-line flags instead.

### Coverage Scripts

**scripts/coverage.ps1** (PowerShell for Windows):

```powershell
# Auto-installs cargo-llvm-cov if needed
# Generates HTML + LCOV reports
# Outputs to target/coverage/
```

**scripts/coverage.sh** (Bash for Linux/macOS):

```bash
# Same functionality as PowerShell version
# Cross-platform coverage script
```

---

## Coverage Report Formats

### HTML Report

- **Generated by**: Both llvm-cov and tarpaulin
- **Location**: `target/coverage/html/index.html`
- **Best for**: Human-readable, line-by-line visualization
- **Contains**: File listings, coverage percentages, color-coded source

### LCOV Report

- **Generated by**: Both llvm-cov and tarpaulin
- **Location**: `target/coverage/lcov.info`
- **Best for**: Tool integration (VS Code extensions, CI systems)
- **Format**: Standard LCOV tracefile format

### Cobertura XML (CI only)

- **Generated by**: tarpaulin (CI)
- **Location**: `coverage/cobertura.xml`
- **Best for**: Codecov, Coveralls, GitLab CI
- **Contains**: Coverage metrics in XML format

---

## Platform-Specific Considerations

### Windows

- **Use**: cargo-llvm-cov (via `scripts/coverage.ps1`)
- **Avoid**: cargo-tarpaulin (file locking issues)
- **IDE**: rust-analyzer compatible, no need to close VS Code

### Linux

- **Use**: cargo-llvm-cov locally, tarpaulin in CI
- **Both tools work**: No file locking issues
- **Preference**: llvm-cov for consistency with Windows devs

### macOS

- **Use**: cargo-llvm-cov (via `scripts/coverage.sh`)
- **Works**: Both tools work, llvm-cov preferred for consistency

---

## Troubleshooting

### Issue: Different Coverage Percentages Between Tools

**Symptom**: llvm-cov shows 82%, tarpaulin shows 80%

**Explanation**:

- Different coverage algorithms
- Different handling of inlined functions
- Different macro expansion tracking

**Expected difference**: 1-3% is normal

**Action**: If difference is >5%, investigate:

1. Check both are running all tests: `cargo test --workspace`
2. Verify both use `--workspace` flag
3. Check for platform-specific `#[cfg]` code

### Issue: "cargo-llvm-cov not found"

**Solution**:

```bash
rustup component add llvm-tools-preview
cargo install cargo-llvm-cov
```

Or use the provided scripts which auto-install.

### Issue: Tarpaulin File Locking on Windows

**Solution**: Don't use tarpaulin on Windows. Use llvm-cov instead.

**Workaround** (if you must use tarpaulin):

```powershell
# Close all IDEs
# Kill rust-analyzer
Get-Process rust-analyzer -ErrorAction SilentlyContinue | Stop-Process

# Run with skip-clean
cargo tarpaulin --workspace --skip-clean
```

### Issue: Coverage Reports Not Generated

**Check**:

1. Output directory exists: `ls target/coverage/`
2. Tests are running: `cargo test --workspace`
3. Tool installed: `cargo llvm-cov --version`

**Solution**:

```bash
# Clean and regenerate
cargo llvm-cov clean
cargo llvm-cov --workspace --html --output-dir target/coverage
```

---

## Implementation Timeline

| Date | Action | Status |
|------|--------|--------|
| Oct 2, 2025 | Identified Windows file locking issue | ✅ Complete |
| Oct 2, 2025 | Investigated solutions | ✅ Complete |
| Oct 2, 2025 | Decided on dual-tool approach | ✅ Complete |
| Oct 3, 2025 | Created coverage scripts | ✅ Complete |
| Oct 3, 2025 | Updated documentation | ✅ Complete |
| Oct 3, 2025 | Verified CI integration | ✅ Complete |

---

## Future Considerations

### Potential Improvements

1. **Unified tool**: If tarpaulin fixes Windows issues, consider standardizing
2. **Coverage enforcement**: Gradually increase `fail-under` threshold
3. **Differential coverage**: Only check coverage on changed lines in PRs
4. **Coverage badges**: Add to README.md when Codecov is configured

### Monitoring

- Watch for tarpaulin Windows support improvements
- Monitor llvm-cov feature development
- Track coverage trends over time
- Adjust thresholds based on project maturity

---

## References

- **cargo-llvm-cov**: <https://github.com/taiki-e/cargo-llvm-cov>
- **cargo-tarpaulin**: <https://github.com/xd009642/tarpaulin>
- **Rust LLVM coverage**: <https://doc.rust-lang.org/rustc/instrument-coverage.html>
- **FerrisScript coverage docs**: See [DEVELOPMENT.md](DEVELOPMENT.md#-code-coverage)

---

*This document serves as technical reference for the coverage setup. For practical usage, see [DEVELOPMENT.md](DEVELOPMENT.md) and [CONTRIBUTING.md](../CONTRIBUTING.md).*
