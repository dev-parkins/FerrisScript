# FerrisScript v0.0.5 Roadmap 🦀

**Version**: 0.0.5 (Patch Release)  
**Focus**: LSP Alpha + Node Safety Fix  
**Timeline**: 4-5 weeks  
**Prerequisites**: v0.0.4 (complete editor + API foundation)

---

## 🎯 Overview

**Strategic Goal**: Implement Language Server Protocol for first-class editor experience + fix node safety issue.

**Key Priorities**:

1. Node invalidation safety fix (Phase 1) 🛡️ NEW
2. LSP server implementation
3. VS Code LSP integration
4. Real-time diagnostics and autocomplete
5. Foundation for advanced IDE features

**Alignment with v0.1.0 Strategy**: **HIGHEST PRIORITY** feature in reprioritized roadmap. Transforms FerrisScript into a professional development language with modern IDE support. Node safety fix ensures robust foundation.

**This is the most critical release** toward v0.1.0, as it delivers the #1 priority: first-class editor integration via LSP, plus addresses a safety issue discovered during v0.0.4 Phase 3 development.

---

## 📦 Critical Priority Deliverables

### 0. Node Invalidation Phase 1 🛡️ NEW

**Status**: Not Started  
**Priority**: 🛡️ **HIGH** (Safety issue discovered during v0.0.4 Phase 3)  
**Timing**: Week 1 (before LSP work starts)

**Rationale**: Current NodeHandle implementation lacks validity checking. Nodes can be freed in Godot, leaving dangling references that can cause crashes or silent errors. This 1-2 hour fix addresses the immediate safety concern while we plan the full ObjectID migration for v0.0.7.

**Scope**:

- [ ] Add `is_valid()` check to NodeHandle
- [ ] Integrate with Godot's `Object::is_instance_valid()`
- [ ] Update node query functions to check validity before operations
- [ ] Add error handling for invalid node access
- [ ] Update examples to show `has_node()` safety pattern
- [ ] Document limitation and proper usage

**Example**:

```rust
// Before (unsafe):
let player: Node = get_node("Player");
player.set_position(x, y); // Could crash if Player freed!

// After (safe):
if has_node("Player") {
    let player: Node = get_node("Player");
    player.set_position(x, y); // Safe - we checked first
}
```

**Implementation Details**:

- Add `is_instance_valid()` binding in godot_bind
- Update NodeHandle with validity checking
- Modify `get_node`, `find_child`, `get_parent` to check validity
- Add tests for freed node scenarios
- Update all examples with safe patterns

**Estimated Effort**: 1-2 hours (1 premium request)  
**Tests**: ~5-7 new tests for validity checking  
**Dependencies**: None (can be done immediately)

**Future Work**: This is Phase 1 of a 3-phase plan. Phase 2 (ObjectID migration) will happen in v0.0.7. See `docs/planning/v0.0.4/NODE_INVALIDATION_RESEARCH.md` for full details.

---

### 1. LSP Server Implementation 🔥🔥🔥

**Status**: Not Started  
**Priority**: 🔥 **CRITICAL** (Highest priority in v0.1.0 roadmap)

**Rationale**: Makes FerrisScript a real development language. Enables professional IDE experience that attracts developers and accelerates adoption.

**Scope**:

#### Phase 1: Basic LSP Server (Week 1-2)

- [ ] Create LSP server project structure
- [ ] Implement LSP protocol handler using `tower-lsp` crate
- [ ] Set up server initialization and capabilities
- [ ] Implement text document synchronization
- [ ] Handle document open/close/change events
- [ ] Basic server logging and debugging

#### Phase 2: Syntax Checking (Week 2)

- [ ] Integrate FerrisScript compiler:
  - Lexer integration
  - Parser integration
  - Type checker integration
- [ ] Real-time syntax error detection
- [ ] Publish diagnostics to client
- [ ] Map compiler errors to LSP diagnostic format
- [ ] Handle incremental document changes

**Example**:

```rust
// User types this in editor:
let x: i32 = "hello";

// LSP immediately shows:
Error[E203]: Type mismatch
  --> example.ferris:1:14
   |
 1 | let x: i32 = "hello";
   |              ^^^^^^^ expected i32, found String
```

#### Phase 3: Autocomplete (Week 3)

- [ ] Implement completion provider
- [ ] Complete keywords:
  - `let`, `let mut`, `fn`, `if`, `else`, `while`, `return`
- [ ] Complete types:
  - `i32`, `f32`, `bool`, `String`, `Vector2`, `Node`, `Color`, etc.
- [ ] Complete built-in functions:
  - `print`, `get_node`, `get_parent`, `has_node`, `emit_signal`
- [ ] Complete user-defined variables
- [ ] Complete user-defined functions
- [ ] Context-aware completion (scope-based)
- [ ] Completion snippets with placeholders

**Example**:

```rust
// User types: "fn "
// LSP suggests:
fn _ready() {
    $0
}

fn _process(delta: f32) {
    $0
}

fn ${1:name}(${2:params}) {
    $0
}
```

#### Phase 4: Go to Definition (Week 3-4)

- [ ] Implement definition provider
- [ ] Jump to variable definition
- [ ] Jump to function definition
- [ ] Jump to type definition
- [ ] Cross-file navigation (if applicable)
- [ ] Definition preview on hover

#### Phase 5: Hover Documentation (Week 4)

- [ ] Implement hover provider
- [ ] Show type information for variables:

  ```
  // Hovering over 'x':
  let x: i32 = 42;
  
  // Shows: (variable) x: i32
  ```

- [ ] Show function signatures:

  ```
  // Hovering over 'print':
  print("Hello");
  
  // Shows: fn print(value: String)
  ```

- [ ] Show documentation for built-in types
- [ ] Show documentation for Godot types
- [ ] Format hover content as Markdown

**Estimated Effort**: 10-15 days

**Technical Stack**:

- `tower-lsp` - LSP protocol implementation
- `tokio` - Async runtime
- `serde` - JSON serialization
- FerrisScript compiler crates (lexer, parser, type checker)

**Components Affected**: New crate: `ferrisscript_lsp`

---

### 2. VS Code LSP Integration

**Status**: Not Started  
**Priority**: Critical

**Prerequisites**: LSP server implementation (Phase 1-2)

**Scope**:

- [ ] Update VS Code extension to use LSP client
- [ ] Configure LSP client connection
- [ ] Start LSP server automatically
- [ ] Handle server lifecycle (start/stop/restart)
- [ ] Configure server settings (port, log level, etc.)
- [ ] Add extension commands:
  - Restart LSP server
  - Show server logs
  - Check server status
- [ ] Handle server crashes gracefully
- [ ] Extension activation on `.ferris` files

**VS Code Extension Updates**:

- [ ] Remove static completion (replaced by LSP)
- [ ] Remove static hover (replaced by LSP)
- [ ] Keep syntax highlighting (complementary)
- [ ] Keep snippets (complementary)
- [ ] Update marketplace description
- [ ] Add screenshots showing LSP features

**Estimated Effort**: 3-4 days

**Dependencies**: npm, VS Code Extension API, vscode-languageclient

---

## 📊 Success Metrics

### Quantitative Goals

- [ ] LSP server responds to requests in < 100ms
- [ ] Real-time error checking works
- [ ] Autocomplete provides 20+ suggestions
- [ ] Go to definition works for all symbols
- [ ] Hover shows information for all types
- [ ] VS Code extension rated 4+ stars

### Qualitative Goals

- [ ] Developers describe experience as "modern"
- [ ] Error detection feels instant
- [ ] Autocomplete feels intuitive
- [ ] IDE features rival mainstream languages
- [ ] FerrisScript development is productive

---

## 📋 Task Breakdown

### Week 1: LSP Foundation

- Day 1-2: LSP server project setup
- Day 3-4: Protocol handler and initialization
- Day 5-7: Text synchronization and basic diagnostics

### Week 2: Syntax Checking & Diagnostics

- Day 1-2: Compiler integration
- Day 3-4: Error mapping and diagnostics
- Day 5-7: Incremental parsing and testing

### Week 3: Autocomplete & Definitions

- Day 1-3: Completion provider
- Day 4-5: Context-aware suggestions
- Day 6-7: Go to definition implementation

### Week 4: Hover & Integration

- Day 1-2: Hover provider
- Day 3-4: VS Code integration
- Day 5-7: Testing and bug fixes

### Week 5 (Buffer/Polish)

- Day 1-2: Performance optimization
- Day 3-4: Edge case handling
- Day 5: Documentation and release

---

## 🔗 Dependencies for Next Version

**Enables v0.0.6-7 and v0.1.0**:

- ✅ LSP working → Developer productivity soars
- ✅ First-class editor → Attracts more contributors
- ✅ Real-time feedback → Faster development of language features
- ✅ Professional tooling → Ready for v0.1.0 release

**Critical Path**:

v0.0.4 (Godot API) → v0.0.5 (LSP) → v0.0.6 (Language Features) → v0.1.0

---

## 📝 Notes

### LSP Architecture

```
┌─────────────────────────────────────────┐
│           VS Code Client                │
│  (Extension using vscode-languageclient)│
└────────────────┬────────────────────────┘
                 │ JSON-RPC over stdio
                 │
┌────────────────▼────────────────────────┐
│       FerrisScript LSP Server           │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │   tower-lsp                     │   │
│  │   (Protocol Handler)            │   │
│  └──────────────┬──────────────────┘   │
│                 │                       │
│  ┌──────────────▼──────────────────┐   │
│  │  FerrisScript Compiler          │   │
│  │  - Lexer                        │   │
│  │  - Parser                       │   │
│  │  - Type Checker                 │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### Testing Strategy

1. **Unit Tests**: Test each LSP feature independently
2. **Integration Tests**: Test LSP server with mock client
3. **Manual Testing**: Test in VS Code with real scripts
4. **Performance Tests**: Measure response times
5. **Stress Tests**: Test with large files

### Known Challenges

1. **Incremental Parsing**: Efficiently re-parsing on document changes
2. **Performance**: Keeping diagnostics fast for large files
3. **State Management**: Tracking multiple open documents
4. **Error Recovery**: Handling invalid syntax gracefully
5. **Async Complexity**: Managing tokio runtime

### Future Enhancements (Post-v0.0.5)

These could be added in v0.0.6 or later:

- [ ] Rename symbol
- [ ] Find references
- [ ] Document symbols (outline view)
- [ ] Workspace symbols (global search)
- [ ] Code actions (quick fixes)
- [ ] Semantic highlighting
- [ ] Inlay hints (type annotations)
- [ ] Call hierarchy
- [ ] Signature help

### Release Checklist

- [ ] All LSP features working
- [ ] VS Code extension updated
- [ ] Extension published to marketplace
- [ ] LSP server binary included
- [ ] Documentation updated with LSP setup
- [ ] Demo video showing LSP features
- [ ] Blog post about LSP implementation
- [ ] CHANGELOG.md updated
- [ ] Version numbers bumped
- [ ] Tag created: v0.0.5
- [ ] GitHub release created

### Communication

- [ ] Major announcement: "LSP Support Arrives"
- [ ] Demo video showing autocomplete and diagnostics
- [ ] Blog post explaining LSP architecture
- [ ] Tweet with side-by-side comparison (before/after)
- [ ] Request community testing and feedback
- [ ] Celebrate milestone achievement

---

## 🚫 Out of Scope

The following are explicitly **NOT** included in v0.0.5:

- ❌ Advanced LSP features (rename, find references, etc.)
- ❌ Debugger integration
- ❌ New language features (arrays, loops, match)
- ❌ Hot reload
- ❌ Multi-file projects (initial focus on single file)
- ❌ Custom LSP extensions

These features are deferred to future versions or v0.1.0.

---

## � Deferred from v0.0.3

The following items were deferred from v0.0.3 release and are now prioritized for v0.0.5:

### 1. LSP Infrastructure - Automated Testing Framework

**Status**: Deferred from Phase 4 (VS Code Extension)  
**Priority**: High  
**Estimated Effort**: 2-3 days

**What It Is**:
Automated testing infrastructure for the FerrisScript VS Code extension, including unit tests for extension logic and integration tests for LSP features.

**Why Deferred**:
Requires LSP server implementation to be functional first. Testing LSP features requires end-to-end integration with language server. Deferring to v0.0.5 ensures we test the complete LSP stack together.

**Current State**: Extension has manual testing only. No automated tests for:

- Extension activation
- Language server client lifecycle
- Syntax highlighting integration
- Command registration
- Configuration handling

**Implementation Notes**:

```typescript
// Example test structure for extension testing
import * as vscode from 'vscode';
import * as assert from 'assert';
import { getDocUri, activate } from './helper';

suite('Extension Test Suite', () => {
    test('Extension should activate on .ferris files', async () => {
        const docUri = getDocUri('test.ferris');
        await activate(docUri);
        
        // Verify extension is active
        const ext = vscode.extensions.getExtension('ferrisscript.ferrisscript');
        assert.ok(ext);
        assert.ok(ext.isActive);
    });
    
    test('LSP client should start', async () => {
        const docUri = getDocUri('test.ferris');
        await activate(docUri);
        
        // Verify language client is running
        // Test will be implemented with LSP server
    });
});

// Integration tests for LSP features
suite('LSP Integration Tests', () => {
    test('Should provide diagnostics for syntax errors', async () => {
        const docUri = getDocUri('syntax_error.ferris');
        await activate(docUri);
        
        const diagnostics = vscode.languages.getDiagnostics(docUri);
        assert.ok(diagnostics.length > 0);
        assert.strictEqual(diagnostics[0].severity, vscode.DiagnosticSeverity.Error);
    });
    
    test('Should provide completions for keywords', async () => {
        // Test autocomplete functionality
    });
    
    test('Should provide hover information', async () => {
        // Test hover provider
    });
});
```

**Scope**:

- [ ] Set up extension testing framework (@vscode/test-electron)
- [ ] Create test fixtures (sample .ferris files)
- [ ] Write unit tests for extension activation
- [ ] Write unit tests for configuration handling
- [ ] Write integration tests for LSP client lifecycle
- [ ] Write integration tests for diagnostics
- [ ] Write integration tests for completion provider
- [ ] Write integration tests for hover provider
- [ ] Write integration tests for go-to-definition
- [ ] Add CI job to run extension tests
- [ ] Document testing setup in extension README

**Dependencies**:

- LSP server implementation (v0.0.5 Phase 1-5)
- VS Code Extension API testing tools
- Mock Godot runtime for integration tests

**Acceptance Criteria**:

- [ ] Extension tests run in CI on every PR
- [ ] Coverage > 60% for extension code
- [ ] All LSP features have integration tests
- [ ] Tests pass consistently on Windows, macOS, Linux
- [ ] Test documentation clearly explains setup

**Related Issues**: Phase 4 implementation in `docs/planning/v0.0.3/phase-4-vscode-extension.md`

---

### 2. LSP Configuration - Editor Settings

**Status**: Deferred from Phase 4/5  
**Priority**: Medium  
**Estimated Effort**: 1-2 days

**What It Is**:
VS Code extension configuration options for LSP behavior, including:

- Enable/disable real-time diagnostics
- Configure diagnostic severity levels
- Adjust completion trigger characters
- Control hover delay
- LSP server logging levels

**Why Deferred**:
Configuration makes sense only after LSP features are implemented and users have preferences to configure. v0.0.3 focused on delivering core features; v0.0.5 adds polish.

**Current State**: Extension has minimal configuration:

- Syntax highlighting theme (handled by VS Code)
- No LSP-specific settings

**Implementation Notes**:

```json
// package.json contribution points
"contributes": {
    "configuration": {
        "type": "object",
        "title": "FerrisScript",
        "properties": {
            "ferrisscript.diagnostics.enable": {
                "type": "boolean",
                "default": true,
                "description": "Enable real-time diagnostics"
            },
            "ferrisscript.diagnostics.level": {
                "type": "string",
                "enum": ["error", "warning", "info", "hint"],
                "default": "error",
                "description": "Minimum diagnostic severity to show"
            },
            "ferrisscript.completion.enable": {
                "type": "boolean",
                "default": true,
                "description": "Enable autocomplete suggestions"
            },
            "ferrisscript.hover.delay": {
                "type": "number",
                "default": 300,
                "description": "Hover information delay (ms)"
            },
            "ferrisscript.lsp.trace": {
                "type": "string",
                "enum": ["off", "messages", "verbose"],
                "default": "off",
                "description": "LSP server trace level"
            },
            "ferrisscript.lsp.serverPath": {
                "type": "string",
                "default": "",
                "description": "Custom path to LSP server binary (empty = bundled)"
            }
        }
    }
}
```

```typescript
// extension.ts - Reading configuration
const config = vscode.workspace.getConfiguration('ferrisscript');
const diagnosticsEnabled = config.get<boolean>('diagnostics.enable', true);
const hoverDelay = config.get<number>('hover.delay', 300);

// Pass to LSP client initialization
const clientOptions: LanguageClientOptions = {
    documentSelector: [{ scheme: 'file', language: 'ferrisscript' }],
    synchronize: {
        configurationSection: 'ferrisscript'
    },
    initializationOptions: {
        diagnosticsEnabled,
        hoverDelay
    }
};
```

**Scope**:

- [ ] Define configuration schema in package.json
- [ ] Add configuration UI in VS Code settings
- [ ] Read configuration in extension activation
- [ ] Pass configuration to LSP server on initialization
- [ ] Handle configuration changes dynamically (didChangeConfiguration)
- [ ] Validate configuration values
- [ ] Document all settings in extension README
- [ ] Add settings screenshots to marketplace listing

**Acceptance Criteria**:

- [ ] All LSP features respect user configuration
- [ ] Configuration changes apply without restart (where possible)
- [ ] Invalid configuration values show helpful errors
- [ ] Settings documented with examples
- [ ] Default settings provide good out-of-box experience

**Related Issues**: Phase 4/5 implementation notes

---

## �📝 Additional Tasks from v0.0.2 Deferral

The following items were deferred from v0.0.2 and align with v0.0.5's focus on testing maturity, CI enhancements, and community growth:

### Type System Improvements

**Priority**: Medium

- [ ] **Type inference for return types** - Infer function return types when not explicitly declared
- [ ] **Type coercion verification** - Ensure implicit type conversions are safe and correct

**Rationale**: Enhance type system robustness. Complements LSP type checking features.

**Estimated Effort**: 2-3 days

---

### Testing & Quality Assurance

**Priority**: High

- [ ] **80%+ test coverage goal** - Improve code coverage from current 70-75% to 80%+:
  - Add tests for error recovery paths
  - Add tests for edge cases
  - Add tests for LSP features
  - Update coverage reports

- [ ] **Integration tests (full pipeline)** - Test complete compilation and execution workflows:
  - Lexer → Parser → Type Checker → Runtime
  - LSP features end-to-end
  - VS Code extension integration
  - Error handling across components

**Rationale**: After LSP implementation, more components to test. Higher coverage ensures reliability.

**Estimated Effort**: 3-4 days

---

### CI/CD Enhancements

**Priority**: Medium

- [ ] **Benchmark tracking in CI** - Automate performance monitoring:
  - Track benchmark results over time
  - Detect performance regressions
  - Generate performance trend reports
  - Alert on significant changes

- [ ] **Release automation improvements** - Streamline release process:
  - Automated version bumping
  - Automated changelog generation
  - Automated GitHub release creation
  - Automated VS Code extension publishing
  - Binary artifact uploading

**Rationale**: After multiple releases (v0.0.2-v0.0.5), patterns established for automation. Reduces manual work.

**Estimated Effort**: 3-4 days

---

### Community & Documentation

**Priority**: Low-Medium

- [ ] **GitHub Wiki** - Create wiki for community content:
  - Tutorials
  - Guides
  - FAQs
  - Community examples
  - Tips and tricks

- [ ] **Label automation** - Automate issue/PR labeling:
  - Auto-label by file path (docs/, src/, examples/)
  - Auto-label by keywords (bug, feature, breaking)
  - Auto-label by size (small, medium, large)
  - Manual label patterns established first

**Rationale**: Community size may justify wiki. Label automation after manual patterns established.

**Estimated Effort**: 2-3 days

---

**Note**: These deferred items are supplementary to the critical LSP deliverable. Prioritize LSP implementation first. Type system improvements enhance LSP functionality. Testing and CI improvements ensure quality as project grows.

---

## 🔮 Additional Opportunities from v0.0.3 (Workstream Prompt Improvements)

### Carried Over from v0.0.4

**1. Automated Pre-Flight Check Script** (1 day) - **Medium Priority**

**Scope**: `scripts/pre-flight.sh` and `.ps1` to automate manual pre-flight checks

**Benefits**: Quality-of-life improvement, reduces repetitive work, consistent check execution

**Rationale**: Can be combined with other dev tooling work in v0.0.5

**Blocker**: No, manual works fine

---

**2. LEARNINGS.md Template Generator** (4-6 hours) - **Medium Priority**

**Scope**: `scripts/generate-learnings-entry.ps1` to create phase entry skeleton

**Benefits**: After LEARNINGS.md template stabilizes (several versions using it), automation reduces friction

**Rationale**: Good fit for v0.0.5 after template has been used across multiple versions

**Blocker**: No, manual template copying works

---

### New Opportunities

**3. LSP Integration for Error Code Quick Fixes** - **Consider During LSP Implementation**

**Discovery from Phase 1 (Error Codes)**: Each error code has structured information (description, example, fix) that could power IDE quick fixes.

**Opportunity**: When implementing LSP support:

- Use error code descriptions for hover tooltips
- Generate quick fixes from "How to Fix" sections
- Link to ERROR_CODES.md documentation from IDE

**Benefit**: Significantly improves developer experience with actionable error messages

**Implementation**: Integrate during Phase 4-5 of LSP implementation

---

**Last Updated**: October 7, 2025  
**Status**: 🟡 Planning  
**Previous Version**: v0.0.4 (Godot API Expansion)  
**Next Version**: v0.0.6 (Language Features - Optional)
